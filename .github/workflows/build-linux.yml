name: Build Linux (C++23 Modules with Clang)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    name: Build with Clang (Modules)
    runs-on: ubuntu-22.04  # should be more stable, without dpkg-lock race condition

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Clang 18 + tools (universal setup)
        run: |
          retry() { for i in {1..5}; do "$@" && break || { echo "Retry $i/5 failed, retrying in 10s..."; sleep 10; }; done; }

          export DEBIAN_FRONTEND=noninteractive
          echo "üßπ Cleaning potential dpkg locks..."
          sudo rm -f /var/lib/dpkg/lock-frontend || true
          sudo rm -f /var/lib/apt/lists/lock || true

          echo "üì¶ Installing base tools..."
          retry sudo apt-get update -y
          retry sudo apt-get install -y wget software-properties-common gnupg lsb-release python3-pip unzip git

          echo "üß© Adding LLVM repository for Clang 18..."
          wget https://apt.llvm.org/llvm.sh -O llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          rm llvm.sh

          echo "üì¶ Adding Kitware repository for CMake >= 3.28..."
          sudo apt-get purge -y cmake || true
          sudo apt-get install -y apt-transport-https ca-certificates gnupg software-properties-common
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://apt.kitware.com/keys/kitware-archive-latest.asc | \
            sudo gpg --dearmor -o /etc/apt/keyrings/kitware-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/kitware.list
          retry sudo apt-get update -y
          retry sudo apt-get install -y cmake

          echo "üß± Installing Ninja >= 1.11..."
          sudo apt-get remove -y ninja-build || true
          wget https://github.com/ninja-build/ninja/releases/download/v1.12.1/ninja-linux.zip
          sudo unzip -o ninja-linux.zip -d /usr/local/bin/
          sudo chmod +x /usr/local/bin/ninja
          ninja --version

          echo "üîß Installing Clang 18, LLD..."
          retry sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            clang-18 clang-tools-18 lld-18

          echo "‚öôÔ∏è Setting Clang 18 as default compiler..."
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100

          echo "üß† Versions check:"
          clang++ --version
          cmake --version
          ninja --version

          echo "üß∞ Installing Catch2 v3 from source..."
          sudo apt-get remove -y catch2 || true
          git clone --branch v3.6.0 https://github.com/catchorg/Catch2.git
          cd Catch2
          cmake -B build -DCMAKE_INSTALL_PREFIX=/usr
          sudo cmake --build build --target install -j$(nproc)
          cd ..
          rm -rf Catch2

          echo "‚úÖ Catch2 installation complete."
          ls /usr/lib/cmake/Catch2 || echo "‚ö†Ô∏è Catch2Config.cmake not found!"

      - name: Configure (Modules)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_EXPERIMENTAL_CXX_MODULE_CMAKE_API=TRUE \
            -DCMAKE_CXX_MODULE_CACHE_DIR=build/module-cache \
            -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build --verbose

      - name: Run Tests
        run: |
          echo "üß™ Running tests..."
          if [ -f build/8051-simulator-tests ]; then
            ./build/8051-simulator-tests || (echo "‚ö†Ô∏è Tests failed"; exit 1)
          else
            ctest --test-dir build --output-on-failure || echo "‚ö†Ô∏è No ctest found, skipping"
          fi
