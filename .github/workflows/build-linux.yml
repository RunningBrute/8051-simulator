name: Build Linux (C++23 Modules with Clang)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    name: Build with Clang (Modules)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Clang 18 + tools
        run: |
          sudo apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y clang-18 clang-tools-18 lld-18 ninja-build cmake python3-pip catch2
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
          ls /usr/bin/clang-scan-deps* || echo "‚ùå clang-scan-deps not found!"
          clang++ --version
          cmake --version

      - name: Configure (Modules)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_EXPERIMENTAL_CXX_MODULE_CMAKE_API=TRUE \
            -DCMAKE_CXX_MODULE_CACHE_DIR=build/module-cache \
            -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build --verbose

      - name: Run tests
        run: ctest --test-dir build --output-on-failure
